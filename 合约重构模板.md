# 合约重构模板：使用RealEstateBaseContract

本文档提供了一个模板，指导如何将现有合约重构为使用`RealEstateBaseContract`基础合约，以实现集中式权限管理。

## 重构步骤

### 1. 修改导入语句

```solidity
// 修改前
import "@openzeppelin/contracts-upgradeable/access/AccessControlUpgradeable.sol";
import "./utils/RoleConstants.sol";
import "./RealEstateSystem.sol";

// 修改后
import "./utils/RoleConstants.sol";
import "./utils/RealEstateBaseContract.sol";
```

### 2. 修改合约继承

```solidity
// 修改前
contract YourContract is 
    Initializable, 
    UUPSUpgradeable, 
    PausableUpgradeable,
    AccessControlUpgradeable {
    
    // 系统合约
    RealEstateSystem public system;
    
    // ...
}

// 修改后
contract YourContract is 
    Initializable, 
    UUPSUpgradeable, 
    PausableUpgradeable,
    RealEstateBaseContract {
    
    // 不再需要声明system变量，它已在基础合约中定义
    
    // ...
}
```

### 3. 修改初始化函数

```solidity
// 修改前
function initialize(address _system) public initializer {
    __UUPSUpgradeable_init();
    __Pausable_init();
    __AccessControl_init();
    
    system = RealEstateSystem(_system);
    
    // 设置默认角色
    _setupRole(DEFAULT_ADMIN_ROLE, msg.sender);
    _setupRole(RoleConstants.ADMIN_ROLE, msg.sender);
    _setupRole(RoleConstants.MANAGER_ROLE, msg.sender);
    _setupRole(RoleConstants.OPERATOR_ROLE, msg.sender);
    
    // ...
}

// 修改后
function initialize(address _system) public initializer {
    __UUPSUpgradeable_init();
    __Pausable_init();
    
    // 设置系统合约 - 使用基础合约中的函数
    _setSystemContract(_system);
    
    // 不再需要设置角色，这将在系统合约中统一管理
    
    // ...
}
```

### 4. 替换所有角色检查

```solidity
// 修改前
function adminFunction() external onlyRole(RoleConstants.ADMIN_ROLE) {
    // ...
}

function managerFunction() external onlyRole(RoleConstants.MANAGER_ROLE) {
    // ...
}

// 修改后
function adminFunction() external onlyAdmin {
    // ...
}

function managerFunction() external onlyManager {
    // ...
}
```

### 5. 修改紧急模式检查

```solidity
// 修改前
function _authorizeUpgrade(address newImplementation) internal override onlyRole(RoleConstants.UPGRADER_ROLE) {
    require(!system.emergencyMode(), "Emergency mode active");
}

// 修改后
function _authorizeUpgrade(address newImplementation) internal override onlyUpgrader {
    _checkEmergencyMode(); // 使用基础合约中的函数
}
```

### 6. 处理授权合约逻辑（如果有）

如果合约有授权其他合约的功能，需要修改修饰符：

```solidity
// 修改前
mapping(address => bool) public authorizedContracts;

modifier onlyAuthorized() {
    require(
        authorizedContracts[msg.sender] || 
        hasRole(RoleConstants.ADMIN_ROLE, msg.sender) ||
        hasRole(RoleConstants.MANAGER_ROLE, msg.sender),
        "Not authorized"
    );
    _;
}

// 修改后
mapping(address => bool) public authorizedContracts;

// 使用基础合约中的modifier，传入mapping
function yourFunction() external onlyAuthorized(authorizedContracts) {
    // ...
}
```

## 完整示例

以下是一个简化的合约重构示例：

### 重构前

```solidity
// SPDX-License-Identifier: MIT
pragma solidity 0.8.20;

import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/security/PausableUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/access/AccessControlUpgradeable.sol";
import "./utils/RoleConstants.sol";
import "./RealEstateSystem.sol";

contract ExampleContract is 
    Initializable, 
    UUPSUpgradeable, 
    PausableUpgradeable,
    AccessControlUpgradeable {
    
    RealEstateSystem public system;
    
    function initialize(address _system) public initializer {
        __UUPSUpgradeable_init();
        __Pausable_init();
        __AccessControl_init();
        
        system = RealEstateSystem(_system);
        
        _setupRole(DEFAULT_ADMIN_ROLE, msg.sender);
        _setupRole(RoleConstants.ADMIN_ROLE, msg.sender);
        _setupRole(RoleConstants.MANAGER_ROLE, msg.sender);
    }
    
    function adminFunction() external onlyRole(RoleConstants.ADMIN_ROLE) {
        // 管理员功能
    }
    
    function managerFunction() external onlyRole(RoleConstants.MANAGER_ROLE) {
        // 经理功能
    }
    
    function _authorizeUpgrade(address newImplementation) internal override onlyRole(RoleConstants.ADMIN_ROLE) {
        require(!system.emergencyMode(), "Emergency mode active");
    }
}
```

### 重构后

```solidity
// SPDX-License-Identifier: MIT
pragma solidity 0.8.20;

import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/security/PausableUpgradeable.sol";
import "./utils/RoleConstants.sol";
import "./utils/RealEstateBaseContract.sol";

contract ExampleContract is 
    Initializable, 
    UUPSUpgradeable, 
    PausableUpgradeable,
    RealEstateBaseContract {
    
    function initialize(address _system) public initializer {
        __UUPSUpgradeable_init();
        __Pausable_init();
        
        _setSystemContract(_system);
    }
    
    function adminFunction() external onlyAdmin {
        // 管理员功能
    }
    
    function managerFunction() external onlyManager {
        // 经理功能
    }
    
    function _authorizeUpgrade(address newImplementation) internal override onlyUpgrader {
        _checkEmergencyMode();
    }
}
```

## 注意事项

1. 确保`RealEstateBaseContract`已经正确实现并包含所有需要的角色修饰符
2. 重构后，所有合约将依赖于系统合约进行角色验证
3. 测试每个功能，确保权限检查正常工作
4. 更新相关测试脚本，以适应新的权限管理方式 