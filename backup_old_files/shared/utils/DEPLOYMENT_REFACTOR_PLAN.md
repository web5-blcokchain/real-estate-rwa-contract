# 部署工具重构计划

## 当前状况

目前部署相关功能分散在四个主要文件中：
- `deployment.js` - 部署状态管理
- `deployment-core.js` - 核心部署功能
- `deployUtils.js` - 部署辅助函数
- `deployer.js` - 部署管理器和策略

这些文件之间存在功能重叠和重复代码，导致维护困难。

## 重构目标

1. 减少代码重复
2. 建立清晰的责任分离
3. 提供一致的API接口
4. 保持向后兼容性
5. 提高可测试性和可维护性

## 三层架构设计

我们将采用清晰的三层架构重构部署工具：

### 1. 基础层 (`deployment-state.js`)

负责部署状态的持久化管理：
- 保存/加载部署状态
- 管理合约地址
- 管理网络配置
- 追踪部署时间戳

### 2. 核心层 (`deployment-core.js`)

提供核心部署功能：
- 部署单个合约（直接部署、可升级部署）
- 部署库合约
- 保存部署记录
- 验证合约

### 3. 策略层 (`deployment-strategy.js`)

实现高级部署策略：
- 多合约部署流程
- 不同部署策略（直接部署、可升级部署、最小部署）
- 角色权限设置
- 部署后操作

## 重构步骤

### 阶段一：重构基础层

1. 创建 `deployment-state.js`，移动状态管理功能：
   - 从 `deployment.js` 提取状态管理功能
   - 添加新的缓存机制提高性能
   - 提供一致的异步接口

2. 调整依赖：
   - 更新其他模块使用新的状态管理接口
   - 添加向后兼容层

### 阶段二：重构核心层

1. 增强 `deployment-core.js`：
   - 合并 `deployUtils.js` 的单合约部署功能
   - 重构库合约部署逻辑，消除重复
   - 统一错误处理和日志记录

2. 创建统一接口：
   - 提供一致的部署函数签名
   - 增强参数验证和类型检查
   - 添加详细文档

### 阶段三：重构策略层

1. 创建 `deployment-strategy.js`：
   - 从 `deployer.js` 提取策略逻辑
   - 使用新的核心层接口
   - 简化部署流程管理

2. 实现策略工厂：
   - 支持自定义部署策略
   - 提供预置策略（标准、最小、测试）

### 阶段四：接口整合与清理

1. 更新 `index.js`：
   - 导出新的三层接口
   - 保留旧接口的兼容层
   - 添加废弃警告

2. 清理旧文件：
   - 逐步弃用 `deployment.js`
   - 移除 `deployUtils.js` 中的重复功能
   - 重构 `deployer.js` 为轻量级接口

## 测试策略

为每个重构阶段创建专门的测试：
1. 单元测试 - 测试各层独立功能
2. 集成测试 - 测试层间交互
3. 端到端测试 - 测试完整部署流程
4. 向后兼容测试 - 确保现有代码不受影响

## 文档计划

1. 每个文件增加详细的JSDoc注释
2. 创建示例代码展示新API用法
3. 更新README说明架构变化
4. 添加迁移指南帮助开发者从旧API迁移

## 时间表

- 阶段一（基础层）：预计 1-2 周
- 阶段二（核心层）：预计 2-3 周
- 阶段三（策略层）：预计 2 周
- 阶段四（整合与清理）：预计 1 周
- 测试与文档：贯穿整个过程

## 风险与缓解

1. **风险**：现有代码依赖部署工具
   **缓解**：保持向后兼容性，分阶段实施

2. **风险**：重构过程中出现bug
   **缓解**：全面的测试覆盖，先在非生产环境验证

3. **风险**：团队成员不熟悉新架构
   **缓解**：详细文档和示例，代码审查会议 