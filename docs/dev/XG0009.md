# 任务XG0009：HTTP服务器重构

## 任务概述

**目标**：重新实现HTTP服务器模块，替换原有的抽象复杂的实现，提供简洁明了的API接口，直接映射到智能合约功能。

**背景**：原有HTTP服务器模块设计过于抽象，代码复杂难以维护，且存在功能问题。通过重构，确保API接口简单易用，并充分利用shared目录中已有的功能模块。

**期望成果**：
- 完整的HTTP API服务器，提供智能合约交互接口
- 清晰的代码结构和文档
- 适当的测试用例和示例

## 设计方案

### 1. 核心设计原则

- **简洁明了**：每个模块功能清晰，避免过度抽象
- **服务于实际需求**：API接口直接映射到合约功能，提供实用价值
- **重用现有模块**：利用`shared`目录中的功能，避免重复实现
- **易于维护**：清晰的错误处理和日志记录
- **安全可靠**：适当的认证和权限控制

### 2. 目录结构

```
http-server/
├── src/
│   ├── config/         - 配置文件
│   ├── controllers/    - 控制器（处理请求，调用服务）
│   ├── middleware/     - 中间件（认证、错误处理等）
│   ├── routes/         - 路由定义
│   ├── services/       - 服务层（业务逻辑，与区块链交互）
│   ├── utils/          - 工具函数
│   └── index.js        - 应用入口
├── tests/              - 单元测试和集成测试
└── package.json        - 项目依赖
```

### 3. 关键技术决策

#### 环境变量管理
- 使用.env文件和shared目录中的环境变量加载功能
- 包含API密钥、区块链配置和账户信息

#### 账户管理方案
采用**方案B - 合约类型对应不同账户**：
- 根据合约类型(PropertyRegistry, TokenFactory等)分配不同账户
- 通过环境变量配置，例如：
  ```
  PROPERTY_ADMIN_PRIVATE_KEY=xxx
  TOKEN_ADMIN_PRIVATE_KEY=xxx
  ```
- 提供基本的权限隔离

#### API架构
- **控制器**：按合约类型组织（PropertyController, TokenController等）
- **路由**：按资源类型分组
  - `/api/properties/...` - 所有不动产相关操作
  - `/api/tokens/...` - 所有代币相关操作
  - `/api/system/...` - 系统操作

#### 与shared目录集成
重用以下模块：
- `config/contracts.js`：合约地址配置
- `utils/getAbis.js`：ABI加载功能
- `services`：合约服务
- `utils/web3Provider.js`：区块链连接
- `middlewares/authMiddleware.js`：认证中间件

## 实施计划

### 阶段1：基础框架搭建
- [x] 创建项目目录结构
- [ ] 设置package.json和依赖
- [ ] 创建基础配置文件
- [ ] 设置认证中间件

### 阶段2：区块链连接
- [ ] 配置提供者和账户管理
- [ ] 建立合约服务适配器
- [ ] 实现交易提交和监控功能

### 阶段3：核心API实现
- [ ] 系统状态API
- [ ] 属性管理API
- [ ] 代币操作API
- [ ] 角色管理API

### 阶段4：测试与文档
- [ ] 编写单元测试
- [ ] 创建API文档
- [ ] 开发示例脚本

### 阶段5：性能优化与部署
- [ ] 应用性能分析与优化
- [ ] 配置生产环境部署
- [ ] 系统集成测试

## 注意事项

1. 公共模块尽可能不修改，如需修改需考虑兼容性并咨询确认
2. 保持清晰的错误处理和日志记录
3. 确保API接口易于使用和理解
4. 提供适当的安全防护措施 