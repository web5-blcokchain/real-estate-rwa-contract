
# 日本房产通证化系统逻辑闭环

## 1. 房产注册与通证化流程

### 1.1 基本流程
1. 房产管理员注册新房产
2. 超级管理员审核房产
3. 房产管理员创建房产代币
4. 系统分配初始代币

### 1.2 涉及合约
- PropertyRegistry
- TokenFactory
- RealEstateToken

### 1.3 具体步骤
1. 房产管理员调用`registerProperty()`注册房产
2. 超级管理员调用`approveProperty()`审核
3. 房产管理员调用`createToken()`创建代币
4. 代币自动分配给初始持有者

## 2. 二级市场交易流程

### 2.1 基本流程
1. 卖家创建销售订单
2. 买家购买代币
3. 系统处理交易
4. 自动收取费用

### 2.2 涉及合约
- Marketplace
- RealEstateToken
- FeeManager

### 2.3 具体步骤
1. 卖家调用`createOrder()`创建订单
2. 买家调用`fulfillOrder()`完成交易
3. 系统自动转移代币和稳定币
4. 系统自动计算并收取交易费用

## 3. 租金分配流程

### 3.1 基本流程
1. 创建租金分配
2. 创建持有者快照
3. 持有者领取租金
4. 自动计算分配比例

### 3.2 涉及合约
- RentDistributor
- RealEstateToken
- TokenHolderQuery

### 3.3 具体步骤
1. 管理员调用`createDistribution()`创建分配
2. 系统自动创建代币快照
3. 持有者调用`claimRent()`领取租金
4. 系统根据持有比例计算金额

## 4. 赎回流程

### 4.1 基本流程
1. 发起赎回流程
2. 持有者请求赎回
3. 处理赎回请求
4. 完成赎回交易

### 4.2 涉及合约
- RedemptionManager
- RealEstateToken
- PropertyRegistry

### 4.3 具体步骤
1. 超级管理员调用`initiateRedemption()`
2. 持有者调用`requestRedemption()`
3. 管理员调用`processRedemption()`
4. 系统自动销毁代币并转移资金

## 5. 系统管理流程

### 5.1 基本流程
1. 角色管理
2. 费用管理
3. 合约升级
4. 系统状态控制

### 5.2 涉及合约
- RoleManager
- FeeManager
- RealEstateSystem

### 5.3 具体步骤
1. 超级管理员管理系统角色
2. 设置和更新系统费用
3. 升级系统合约
4. 控制系统运行状态

## 6. 异常处理流程

### 6.1 基本流程
1. 交易失败处理
2. 状态回滚
3. 紧急暂停
4. 错误恢复

### 6.2 涉及合约
- RealEstateSystem
- RealEstateToken
- Marketplace

### 6.3 具体步骤
1. 检测交易异常
2. 触发状态回滚
3. 启动紧急暂停
4. 执行恢复操作

## 7. 费用管理流程

### 7.1 基本流程
1. 设置费用比例
2. 收取交易费用
3. 费用分配
4. 费用提取

### 7.2 涉及合约
- FeeManager
- Marketplace
- RentDistributor

### 7.3 具体步骤
1. 设置各类费用比例
2. 自动收取交易费用
3. 系统自动分配费用
4. 费用收集者提取费用

## 8. 数据查询流程

### 8.1 基本流程
1. 房产信息查询
2. 代币信息查询
3. 交易记录查询
4. 持有者查询

### 8.2 涉及合约
- PropertyRegistry
- TokenHolderQuery
- Marketplace
- RealEstateToken

### 8.3 具体步骤
1. 调用相应查询接口
2. 获取目标数据
3. 返回查询结果
4. 展示数据信息

## 9. 权限控制流程

### 9.1 基本流程
1. 角色分配
2. 权限验证
3. 操作授权
4. 权限撤销

### 9.2 涉及合约
- RoleManager
- RealEstateSystem
- PropertyRegistry

### 9.3 具体步骤
1. 分配系统角色
2. 验证操作权限
3. 执行授权操作
4. 撤销相关权限

## 10. 系统升级流程

### 10.1 基本流程
1. 准备新合约
2. 验证兼容性
3. 执行升级
4. 验证升级结果

### 10.2 涉及合约
- RealEstateSystem
- 所有可升级合约

### 10.3 具体步骤
1. 部署新合约实现
2. 验证状态兼容性
3. 执行合约升级
4. 确认升级成功


