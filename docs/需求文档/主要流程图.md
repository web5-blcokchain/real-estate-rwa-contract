
# 日本房产通证化系统流程图

## 1. 房产注册与通证化流程

```mermaid
sequenceDiagram
    participant PM as 房产管理员
    participant PR as PropertyRegistry
    participant SA as 超级管理员
    participant TF as TokenFactory
    participant RT as RealEstateToken

    PM->>PR: registerProperty()
    PR-->>PM: 返回注册结果
    SA->>PR: approveProperty()
    PR-->>SA: 返回审核结果
    PM->>TF: createToken()
    TF->>RT: 部署新代币合约
    RT-->>TF: 返回代币地址
    TF-->>PM: 返回创建结果
```

## 2. 二级市场交易流程

```mermaid
sequenceDiagram
    participant S as 卖家
    participant M as Marketplace
    participant B as 买家
    participant RT as RealEstateToken
    participant FM as FeeManager

    S->>M: createOrder()
    M-->>S: 返回订单ID
    B->>M: fulfillOrder()
    M->>FM: 计算交易费用
    M->>RT: 转移代币
    M->>B: 转移稳定币
    M-->>B: 返回交易结果
```

## 3. 租金分配流程

```mermaid
sequenceDiagram
    participant PM as 房产管理员
    participant RD as RentDistributor
    participant RT as RealEstateToken
    participant H as 代币持有者
    participant THQ as TokenHolderQuery

    PM->>RD: createDistribution()
    RD->>RT: 创建快照
    RT-->>RD: 返回快照ID
    H->>RD: claimRent()
    RD->>THQ: 查询持有比例
    RD->>H: 转移租金
    RD-->>H: 返回领取结果
```

## 4. 赎回流程

```mermaid
sequenceDiagram
    participant SA as 超级管理员
    participant RM as RedemptionManager
    participant H as 代币持有者
    participant RT as RealEstateToken
    participant PR as PropertyRegistry

    SA->>RM: initiateRedemption()
    H->>RM: requestRedemption()
    RM->>PR: 更新房产状态
    SA->>RM: processRedemption()
    RM->>RT: 销毁代币
    RM->>H: 转移赎回资金
    RM-->>H: 返回赎回结果
```

## 5. 系统管理流程

```mermaid
sequenceDiagram
    participant SA as 超级管理员
    participant RoM as RoleManager
    participant FM as FeeManager
    participant RS as RealEstateSystem

    SA->>RoM: grantRole()
    SA->>FM: updateFee()
    SA->>RS: upgradeContract()
    SA->>RS: setSystemStatus()
    RS-->>SA: 返回操作结果
```

## 6. 异常处理流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant RS as RealEstateSystem
    participant RT as RealEstateToken
    participant M as Marketplace

    U->>M: 执行交易
    M->>RS: 检测异常
    RS->>RT: 暂停操作
    RS->>M: 回滚状态
    RS-->>U: 返回错误信息
```

## 7. 费用管理流程

```mermaid
sequenceDiagram
    participant SA as 超级管理员
    participant FM as FeeManager
    participant M as Marketplace
    participant FC as 费用收集者

    SA->>FM: updateFee()
    M->>FM: calculateFee()
    FM->>FC: collectFee()
    FM-->>M: 返回费用信息
```

## 8. 数据查询流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant PR as PropertyRegistry
    participant THQ as TokenHolderQuery
    participant M as Marketplace
    participant RT as RealEstateToken

    U->>PR: 查询房产信息
    U->>THQ: 查询持有者信息
    U->>M: 查询交易记录
    U->>RT: 查询代币信息
    RT-->>U: 返回查询结果
```

## 9. 权限控制流程

```mermaid
sequenceDiagram
    participant SA as 超级管理员
    participant RoM as RoleManager
    participant RS as RealEstateSystem
    participant U as 用户

    SA->>RoM: 分配角色
    U->>RS: 请求操作
    RS->>RoM: 验证权限
    RoM-->>RS: 返回验证结果
    RS-->>U: 执行/拒绝操作
```

## 10. 系统升级流程

```mermaid
sequenceDiagram
    participant SA as 超级管理员
    participant RS as RealEstateSystem
    participant NC as 新合约
    participant OC as 旧合约

    SA->>RS: 部署新合约
    RS->>NC: 验证兼容性
    RS->>OC: 暂停操作
    RS->>NC: 升级实现
    RS->>OC: 迁移数据
    RS-->>SA: 返回升级结果
```