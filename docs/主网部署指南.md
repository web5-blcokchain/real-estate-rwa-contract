# 日本房产通证化系统 - 主网部署指南

本文档提供在以太坊主网上部署日本房产通证化系统的详细指南，特别关注合约大小限制的解决方案以及手动部署流程。

## 目录

- [1. 主网部署挑战](#1-主网部署挑战)
- [2. 部署准备工作](#2-部署准备工作)
- [3. 手动部署流程](#3-手动部署流程)
- [4. 部署后验证](#4-部署后验证)
- [5. 故障排除](#5-故障排除)
- [6. 安全建议](#6-安全建议)

## 1. 主网部署挑战

在以太坊主网部署系统面临的主要挑战是合约大小限制。以太坊"Spurious Dragon"硬分叉引入了24KB的合约大小限制，而我们的`SystemDeployer`合约超过了此限制。

为解决此问题，我们采用了以下策略：

1. **合约拆分**：将大型合约分离为多个较小的合约
2. **手动分步部署**：使用`manual-deploy.js`脚本进行逐步部署
3. **部署状态跟踪**：记录每个步骤的部署状态，便于恢复和验证

## 2. 部署准备工作

### 2.1 环境准备

1. 确保已正确配置`.env`文件，包含：
   - `PRIVATE_KEY`：拥有足够ETH的账户私钥
   - `MAINNET_RPC_URL`：主网RPC URL
   - `BSCSCAN_API_KEY`：用于合约验证

2. 安装依赖：
   ```bash
   npm install
   ```

3. 验证环境变量：
   ```bash
   node scripts/utils/validate-env.js
   ```

### 2.2 部署状态初始化

运行以下命令初始化部署状态：

```bash
npx hardhat run scripts/manual-deploy.js --network bsc_mainnet
```

此命令将创建初始部署状态文件，记录在`deployments/manual-deploy-status-bsc_mainnet.json`中。

## 3. 手动部署流程

### 3.1 部署步骤概述

系统部署按以下顺序进行：

1. 部署`RoleManager`
2. 部署`FeeManager`
3. 部署`TokenManager`
4. 部署`PropertyRegistry`
5. 部署`PropertyERC721`
6. 部署`PropertyERC20Factory`
7. 部署`PropertyExchange`
8. 部署`RestrictedTokenRouter`
9. 部署`RentalManager`
10. 部署`RentDistributionManager`
11. 部署`RealEstateSystem`
12. 授予`SUPER_ADMIN`角色

### 3.2 执行部署步骤

执行下一步部署：

```bash
npx hardhat run scripts/manual-deploy.js --network bsc_mainnet next
```

重复上述命令直到所有步骤完成。可随时使用以下命令查看当前部署状态：

```bash
npx hardhat run scripts/manual-deploy.js --network bsc_mainnet status
```

### 3.3 部署特定步骤

如需部署特定步骤：

```bash
npx hardhat run scripts/manual-deploy.js --network bsc_mainnet step <步骤编号>
```

### 3.4 保存部署记录

部署完成后，将部署状态保存为标准格式：

```bash
npx hardhat run scripts/manual-deploy.js --network bsc_mainnet save
```

此命令将创建标准格式的部署记录，与`deploy-unified.js`生成的格式兼容。

## 4. 部署后验证

### 4.1 验证合约功能

使用验证脚本检查所有合约的部署状态和相互引用关系：

```bash
npx hardhat run scripts/verify-deployment.js --network bsc_mainnet
```

### 4.2 验证合约源代码

在BSCScan上验证所有合约的源代码：

```bash
npx hardhat run scripts/verify/verify.js --network bsc_mainnet
```

### 4.3 手动验证关键功能

部署完成后，建议手动测试以下关键功能：

1. 各种角色分配是否正确
2. 属性注册和通证化流程
3. 交易功能
4. 租金分配机制

## 5. 故障排除

### 5.1 部署失败处理

如果某个步骤部署失败：

1. 检查错误信息，解决问题
2. 使用`step`命令重新执行失败的步骤：
   ```bash
   npx hardhat run scripts/manual-deploy.js --network bsc_mainnet step <失败步骤编号>
   ```

### 5.2 中断恢复

如果部署过程中断，可以使用以下命令检查当前状态并继续：

```bash
# 检查状态
npx hardhat run scripts/manual-deploy.js --network bsc_mainnet status

# 继续下一步
npx hardhat run scripts/manual-deploy.js --network bsc_mainnet next
```

### 5.3 合约验证问题

如果合约验证失败：

1. 确保`BSCSCAN_API_KEY`正确
2. 手动验证：使用Hardhat的`verify:verify`任务
   ```bash
   npx hardhat verify:verify --network bsc_mainnet <合约地址> <构造函数参数>
   ```

## 6. 安全建议

### 6.1 私钥管理

- 确保部署私钥存储安全，不要共享或泄露
- 使用硬件钱包或其他安全方式存储私钥
- 部署完成后考虑转移管理员权限到多签钱包

### 6.2 权限管理

- 确保正确设置所有角色和权限
- 验证关键功能的访问控制
- 考虑实施时间锁定机制用于管理员操作

### 6.3 部署记录备份

- 备份所有部署记录和状态文件
- 记录每个合约的地址和功能
- 保存部署日志以便将来参考 