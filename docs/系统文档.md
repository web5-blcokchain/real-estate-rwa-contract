# 日本房产通证化系统文档

## 1. 项目概述

日本房产通证化系统是一个基于区块链技术的平台，允许将实物房产资产转化为区块链上的数字通证，实现资产的流动性和交易便捷性。系统包括房产注册、通证化、交易市场、租金分配和赎回等功能模块。

### 1.1 项目背景

传统房产投资存在以下问题：
- 高门槛：单个房产价格昂贵，普通投资者难以参与
- 流动性差：房产交易周期长，变现困难
- 管理复杂：跨国房产管理涉及多方协调
- 法律障碍：产权分割和转让涉及复杂法律程序

通过区块链技术将房产通证化，可以解决以上问题：
- 降低投资门槛：将房产分割成小额通证，普通投资者可以购买部分权益
- 提高流动性：通证可以在区块链上快速交易
- 简化管理：自动化收益分配和权益管理
- 规范合规：使用智能合约确保操作符合预设规则

### 1.2 技术栈

- Solidity 0.8.19
- Hardhat开发环境
- OpenZeppelin合约库
- BSC区块链网络

## 2. 系统架构

### 2.1 核心合约

1. **RoleManager**: 管理系统角色和权限
2. **FeeManager**: 管理系统各种费用
3. **PropertyRegistry**: 记录房产信息
4. **RentDistributor**: 处理租金分配
5. **RealEstateToken**: 房产通证的实现
6. **TokenFactory**: 创建新的房产通证
7. **RedemptionManager**: 处理通证赎回
8. **Marketplace**: 通证交易市场
9. **TokenHolderQuery**: 查询通证持有者
10. **RealEstateSystem**: 系统主合约，协调其他组件

### 2.2 系统角色

- **超级管理员(SUPER_ADMIN)**: 拥有系统的最高权限
- **房产管理员(PROPERTY_MANAGER)**: 负责管理房产资产
- **费用收集者(FEE_COLLECTOR)**: 负责收集系统费用

### 2.3 系统架构图

```
+----------------+     +----------------+     +----------------+
|                |     |                |     |                |
| RealEstateSystem <---+ RoleManager    |     | PropertyRegistry |
|                |     |                |     |                |
+--------^-------+     +----------------+     +--------^-------+
         |                                            |
+--------v-------+     +----------------+     +-------v--------+
|                |     |                |     |                |
| FeeManager     |     | TokenFactory   +---->+ RealEstateToken |
|                |     |                |     |                |
+----------------+     +--------^-------+     +--------^-------+
                                |                      |
+----------------+     +--------v-------+     +--------v-------+
|                |     |                |     |                |
| TokenHolderQuery |   | Marketplace    |     | RentDistributor |
|                |     |                |     |                |
+----------------+     +----------------+     +----------------+
                                               |
                                     +---------v--------+
                                     |                  |
                                     | RedemptionManager |
                                     |                  |
                                     +------------------+
```

## 3. 核心功能

### 3.1 房产注册与通证化

- **房产注册**: 房产管理员注册房产基本信息
- **房产审核**: 超级管理员审核房产信息
- **通证创建**: 为已审核房产创建代表所有权的ERC20通证
- **初始分配**: 系统自动分配初始通证给指定地址

### 3.2 通证交易市场

- **创建订单**: 通证持有者可以创建销售订单
- **购买通证**: 买家可以购买销售中的通证
- **取消订单**: 卖家可以取消自己的未成交订单
- **交易费用**: 系统自动收取交易费用

### 3.3 租金分配

- **租金收集**: 管理员录入房产租金信息
- **创建快照**: 在分配租金时创建持有者快照
- **按比例分配**: 根据通证持有比例计算分配金额
- **租金领取**: 通证持有者可以领取应得的租金

### 3.4 赎回机制

- **赎回发起**: 超级管理员可以发起赎回流程
- **赎回请求**: 通证持有者可以请求赎回自己的通证
- **资金转移**: 系统自动销毁通证并转移相应资金
- **赎回费用**: 在赎回过程中收取一定的赎回费用

### 3.5 费用管理

- **通证化费用**: 创建通证时收取
- **交易费用**: 二级市场交易时收取
- **赎回费用**: 赎回通证时收取
- **平台费用**: 从租金中扣除的平台运营费用
- **维护费用**: 从租金中扣除的房产维护费用

## 4. 业务流程

### 4.1 房产注册与通证化流程

1. 房产管理员调用`registerProperty()`注册新房产
2. 超级管理员调用`approveProperty()`审核房产
3. 房产管理员调用`createToken()`创建通证
4. 系统自动铸造并分配初始通证
5. 系统收取通证化费用

### 4.2 通证交易流程

1. 卖家授权市场合约(approve)操作其通证
2. 卖家创建销售订单(createOrder)
3. 买家购买订单(fulfillOrder)
4. 系统自动转移通证给买家，转移资金给卖家
5. 系统自动收取交易费用

### 4.3 租金分配流程

1. 管理员创建租金分配(createDistribution)
2. 系统自动创建通证持有者快照
3. 系统扣除平台费用和维护费用
4. 通证持有者领取租金(claimRent)
5. 系统根据持有比例计算并转移租金

### 4.4 赎回流程

1. 超级管理员发起赎回(initiateRedemption)
2. 通证持有者授权赎回管理合约
3. 通证持有者请求赎回(requestRedemption)
4. 管理员处理赎回请求(processRedemption)
5. 系统销毁通证并转移资金
6. 系统收取赎回费用

### 4.5 系统管理流程

1. 超级管理员管理系统角色
2. 设置和更新系统费用
3. 升级系统合约
4. 控制系统状态(活跃/暂停)

## 5. 合约详解

### 5.1 RoleManager

负责管理系统中的角色和权限，确保只有授权用户可以执行特定操作。

**主要功能**:
- 角色分配与撤销
- 权限验证
- 多级权限管理

### 5.2 PropertyRegistry

管理房产信息的注册和状态变更。

**主要功能**:
- 房产注册
- 房产审核
- 状态管理(待审核、已审核、通证化、赎回中)
- 房产信息查询

### 5.3 TokenFactory

创建和管理代表房产所有权的ERC20通证。

**主要功能**:
- 为房产创建通证
- 部署新的通证合约
- 收取通证化费用
- 初始通证分配

### 5.4 RealEstateToken

实现房产通证的功能，包括转账限制和快照功能。

**主要功能**:
- 符合ERC20标准
- 支持余额快照
- 转账限制(根据房产状态)
- 铸造与销毁功能

### 5.5 Marketplace

提供二级市场功能，允许用户买卖房产通证。

**主要功能**:
- 创建销售订单
- 订单购买
- 订单取消
- 交易费用收取

### 5.6 RentDistributor

管理租金的收集和分配给通证持有者。

**主要功能**:
- 创建租金分配
- 租金快照管理
- 租金领取
- 平台费用和维护费用扣除

### 5.7 RedemptionManager

管理通证的赎回流程。

**主要功能**:
- 发起赎回流程
- 处理赎回请求
- 赎回资金管理
- 赎回费用计算

### 5.8 FeeManager

管理系统中的各种费用设置和收取。

**主要功能**:
- 费用比例设置
- 费用计算
- 费用收集者管理

### 5.9 TokenHolderQuery

提供查询通证持有者信息的功能。

**主要功能**:
- 查询通证持有者列表
- 查询特定快照时的余额分布

### 5.10 RealEstateSystem

系统的主合约，负责管理和协调其他合约。

**主要功能**:
- 合约地址管理
- 系统状态控制
- 合约升级管理
- 跨合约调用协调

## 6. 开发环境搭建

### 6.1 环境要求

- Node.js v14.0.0 或更高版本
- npm v6.0.0 或更高版本
- Git

### 6.2 安装依赖

```bash
# 克隆代码库
git clone <repository-url>
cd japan-rwa

# 安装依赖
npm install
```

### 6.3 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑.env文件，填写必要的配置信息
vim .env
```

必要的环境变量包括：

```
# 部署网络
DEPLOY_NETWORK=bsc_testnet

# RPC URL
MAINNET_RPC_URL=https://bsc-dataseed.binance.org/
TESTNET_RPC_URL=https://data-seed-prebsc-1-s1.binance.org:8545/

# 部署账户私钥
PRIVATE_KEY=your-private-key

# 验证API密钥
BSCSCAN_API_KEY=your-api-key
```

## 7. 测试指南

### 7.1 单元测试

单元测试位于 `test/` 目录下，使用 Hardhat 和 Chai 进行测试。

```bash
# 运行所有测试
npx hardhat test

# 运行特定测试文件
npx hardhat test test/PropertyRegistry.test.js

# 运行带有特定标签的测试
npx hardhat test --grep "PropertyRegistry"
```

### 7.2 本地环境测试

使用 Hardhat 本地节点进行开发和测试：

```bash
# 启动本地节点
npx hardhat node

# 在另一个终端使用手动部署脚本
npx hardhat run scripts/manual-deploy.js --network localhost
```

### 7.3 调试技巧

#### 使用 Hardhat 控制台

```bash
# 启动交互式控制台
npx hardhat console --network localhost

# 在控制台中与合约交互
> const RealEstateSystem = await ethers.getContractFactory("RealEstateSystem")
> const system = await RealEstateSystem.attach("0x...")
> await system.isSystemActive()
```

#### 使用合约日志

在合约中使用 `console.log`（需要导入 Hardhat 的控制台库）：

```solidity
import "hardhat/console.sol";

function someFunction() public {
    console.log("Value:", someValue);
    // ...
}
```

## 8. 部署指南

### 8.1 测试网部署

#### 部署准备

1. 确保 `.env` 文件中的配置正确
2. 确保部署账户有足够的资金支付部署费用
3. 检查网络连接是否正常

#### 使用手动部署脚本

我们提供了`scripts/manual-deploy.js`脚本，支持分步部署，跟踪部署状态。

```bash
# 初始化部署状态
npx hardhat run scripts/manual-deploy.js --network bsc_testnet

# 执行下一个部署步骤
npx hardhat run scripts/manual-deploy.js --network bsc_testnet next

# 查看当前部署状态
npx hardhat run scripts/manual-deploy.js --network bsc_testnet status

# 执行特定部署步骤
npx hardhat run scripts/manual-deploy.js --network bsc_testnet step <step_number>
```

#### 部署后验证

使用验证脚本检查系统组件是否正确配置：

```bash
# 运行验证脚本
npx hardhat run scripts/verify-deployment.js --network bsc_testnet
```

### 8.2 主网部署

由于以太坊主网对合约大小有24,576字节的限制，而我们的系统库合约超出此限制：

- SystemDeployerLib1: ~41,940字节
- SystemDeployerLib2: ~39,089字节

我们采用手动分步部署策略来解决此问题。

#### 部署前准备

1. 确保在测试网上充分测试整个系统
2. 检查 `.env` 文件中的主网配置
3. 确保部署账户有足够的资金

#### 部署步骤

使用与测试网相同的手动部署脚本，但指定主网网络：

```bash
# 初始化部署状态
npx hardhat run scripts/manual-deploy.js --network bsc_mainnet

# 按顺序执行部署步骤
npx hardhat run scripts/manual-deploy.js --network bsc_mainnet next
```

系统按以下顺序部署各合约：

1. RoleManager
2. FeeManager
3. PropertyRegistry
4. RentDistributor
5. RealEstateToken（通证实现）
6. TokenFactory
7. RedemptionManager
8. Marketplace
9. TokenHolderQuery
10. RealEstateSystem
11. 授予SUPER_ADMIN角色

每个步骤完成后，脚本会更新`deploy-state.json`文件以保存部署状态。

## 9. 故障排除

### 9.1 常见问题

#### 部署问题

1. **部署交易失败**
   - 增加gas价格和gas限制
   - 检查网络连接是否稳定
   - 确保账户有足够的资金

2. **合约验证失败**
   - 确保 BSCSCAN_API_KEY 正确
   - 检查合约构造函数参数是否正确
   - 尝试手动验证

3. **部署中断恢复**
   - 重新运行脚本，它会从上次成功的步骤继续

```bash
npx hardhat run scripts/manual-deploy.js --network <network_name> status
npx hardhat run scripts/manual-deploy.js --network <network_name> next
```

### 9.2 安全注意事项

1. **私钥安全**：
   - 避免将私钥直接放入代码或公开仓库
   - 使用环境变量或安全的密钥管理工具

2. **部署环境**：
   - 使用安全的、隔离的环境进行部署
   - 避免在公共网络或不安全的网络上进行部署操作

3. **权限控制**：
   - 确保仅将必要的角色授予相应的地址
   - 定期审查系统权限 