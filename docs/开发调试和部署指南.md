

# 日本房产通证化系统开发文档

## 1. 项目概述

日本房产通证化系统是一个基于区块链技术的平台，允许将实物房产资产转化为区块链上的数字通证，实现资产的流动性和交易便捷性。系统包括房产注册、通证化、交易市场、租金分配和赎回等功能模块。

## 2. 开发环境搭建

### 2.1 环境要求

- Node.js v14.0.0 或更高版本
- npm v6.0.0 或更高版本
- Git

### 2.2 安装依赖

```bash
# 克隆代码库
git clone <repository-url>
cd japan-rwa

# 安装依赖
npm install
```

### 2.3 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑.env文件，填写必要的配置信息
vim .env
```

必要的环境变量包括：

```
# 部署网络
DEPLOY_NETWORK=bsc_testnet

# RPC URL
BSC_MAINNET_RPC=https://bsc-dataseed.binance.org/
BSC_TESTNET_RPC=https://data-seed-prebsc-1-s1.binance.org:8545/

# 部署账户私钥
PRIVATE_KEY=your-private-key

# 角色地址
SUPER_ADMIN_ADDRESS=0x...
PROPERTY_MANAGER_ADDRESS=0x...
FEE_COLLECTOR_ADDRESS=0x...

# 费用设置 (基点，100 = 1%)
TRADING_FEE=50
TOKENIZATION_FEE=100
REDEMPTION_FEE=30
PLATFORM_FEE=20

# 验证API密钥
BSCSCAN_API_KEY=your-api-key
```

## 3. 项目结构

```
japan-rwa/
├── contracts/             # 智能合约源代码
│   ├── core/              # 核心合约
│   ├── interfaces/        # 接口定义
│   ├── marketplace/       # 市场相关合约
│   ├── property/          # 房产相关合约
│   ├── token/             # 通证相关合约
│   └── utils/             # 工具合约
├── scripts/               # 部署和工具脚本
│   ├── config/            # 配置文件
│   ├── test/              # 功能测试脚本
│   ├── utils/             # 工具函数
│   ├── deploy-unified.js  # 统一部署入口
│   └── deploy-network.sh  # 网络特定部署脚本
├── test/                  # 单元测试
├── deployments/           # 部署记录
└── logs/                  # 日志文件
```

## 4. 开发指南

### 4.1 智能合约开发

所有智能合约都位于 `contracts/` 目录下，使用 Solidity 语言编写。

#### 合约修改流程

1. 在本地分支上修改合约代码
2. 编写单元测试，确保功能正确
3. 运行测试：`npx hardhat test`
4. 提交代码并创建合并请求

### 4.2 单元测试

单元测试位于 `test/` 目录下，使用 Hardhat 和 Chai 进行测试。

```bash
# 运行所有测试
npx hardhat test

# 运行特定测试文件
npx hardhat test test/PropertyRegistry.test.js

# 运行带有特定标签的测试
npx hardhat test --grep "PropertyRegistry"
```

### 4.3 本地开发环境

使用 Hardhat 本地节点进行开发和测试：

```bash
# 启动本地节点
npx hardhat node

# 在另一个终端部署合约到本地节点
npx hardhat run scripts/deploy-unified.js --network localhost
```

## 5. 调试指南

### 5.1 合约调试

#### 使用 Hardhat 控制台

```bash
# 启动交互式控制台
npx hardhat console --network localhost

# 在控制台中与合约交互
> const RealEstateSystem = await ethers.getContractFactory("RealEstateSystem")
> const system = await RealEstateSystem.attach("0x...")
> await system.isSystemActive()
```

#### 使用日志

在合约中使用 `console.log`（需要导入 Hardhat 的控制台库）：

```solidity
import "hardhat/console.sol";

function someFunction() public {
    console.log("Value:", someValue);
    // ...
}
```

### 5.2 脚本调试

使用 Node.js 调试器或 VS Code 调试器：

```bash
# 使用Node.js调试器
node --inspect-brk $(which hardhat) run scripts/deploy-unified.js
```

在 VS Code 中，创建 `.vscode/launch.json` 文件：

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Debug Deploy Script",
      "program": "${workspaceFolder}/node_modules/.bin/hardhat",
      "args": ["run", "scripts/deploy-unified.js", "--network", "localhost"],
      "console": "integratedTerminal"
    }
  ]
}
```

### 5.3 日志分析

系统会在 `logs/` 目录下生成详细的部署和错误日志：

```bash
# 查看最新的部署日志
cat logs/deploy-$(date +%Y-%m-%d).log

# 查看错误日志
cat logs/deploy-error-*.log
```

## 6. 部署指南

### 6.1 部署准备

1. 确保 `.env` 文件中的配置正确
2. 确保部署账户有足够的资金支付部署费用
3. 检查网络连接是否正常

### 6.2 部署到测试网

使用统一部署脚本：

```bash
# 部署到BSC测试网
npx hardhat run scripts/deploy-unified.js --network bsc_testnet
```

或使用网络特定部署脚本：

```bash
# 部署到BSC测试网
./scripts/deploy-network.sh bsc_testnet
```

### 6.3 部署到主网

**注意：部署到主网前，请确保已经在测试网上充分测试。**

```bash
# 部署到BSC主网
npx hardhat run scripts/deploy-unified.js --network bsc_mainnet
```

或使用网络特定部署脚本：

```bash
# 部署到BSC主网
./scripts/deploy-network.sh bsc_mainnet
```

### 6.4 合约验证

部署脚本会自动生成验证脚本，可以手动运行验证：

```bash
# 验证BSC测试网合约
npx hardhat run scripts/verify-bsc_testnet.js --network bsc_testnet

# 验证BSC主网合约
npx hardhat run scripts/verify-bsc_mainnet.js --network bsc_mainnet
```

### 6.5 部署后检查

1. 检查部署记录文件：`deployments/<network>-latest.json`
2. 运行功能测试脚本：`npx hardhat run scripts/test/functionality-test.js --network <network>`
3. 在区块链浏览器上验证合约地址和交易

## 7. 系统管理

### 7.1 角色管理

系统定义了以下角色：
- 超级管理员 (SUPER_ADMIN)：拥有系统的最高权限
- 房产管理员 (PROPERTY_MANAGER)：负责管理房产资产
- 费用收集者 (FEE_COLLECTOR)：负责收集系统费用

### 7.2 费用设置

系统包含以下费用类型：
- 交易费用 (trading)：通证交易时收取
- 通证化费用 (tokenization)：房产通证化时收取
- 赎回费用 (redemption)：通证赎回时收取
- 平台费用 (platform)：平台运营费用

### 7.3 系统升级

系统使用 OpenZeppelin 的可升级合约模式，可以在不丢失状态的情况下升级合约逻辑：

```bash
# 升级特定合约
npx hardhat run scripts/upgrade/upgrade-contract.js --network <network>
```

## 8. 故障排除

### 8.1 常见问题

1. **部署失败**
   - 检查网络连接
   - 确保账户有足够的资金
   - 查看错误日志

2. **合约验证失败**
   - 确保 BSCSCAN_API_KEY 正确
   - 检查合约构造函数参数是否正确
   - 尝试手动验证

3. **交易失败**
   - 检查 gas 限制和价格
   - 确认调用者有正确的权限
   - 检查合约状态是否正确

### 8.2 日志和监控

- 部署日志：`logs/deploy-*.log`
- 错误日志：`logs/deploy-error-*.log`
- 部署记录：`deployments/<network>-*.json`

## 9. 联系和支持

如有问题或需要支持，请联系项目维护者：

- 技术支持：[技术支持邮箱]
- 项目管理：[项目管理邮箱]
 