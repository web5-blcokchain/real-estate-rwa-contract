# 不动产系统权限清单

## 角色定义

系统定义了三个主要角色，按照权限级别从高到低排序：

1. `ADMIN_ROLE`: 最高权限，包含所有权限
2. `MANAGER_ROLE`: 管理权限，包含OPERATOR权限
3. `OPERATOR_ROLE`: 基础操作权限

## 合约权限清单

### 1. RealEstateFacade

#### ADMIN_ROLE 权限
- `initialize`: 初始化合约
- `setSystem`: 设置系统合约
- `pause`: 暂停所有操作
- `unpause`: 恢复所有操作
- `_authorizeUpgrade`: 授权合约升级

#### MANAGER_ROLE 权限
- `updatePropertyValuation`: 更新房产估值
- `updateTradingLimits`: 更新交易限制
- `createDistribution`: 创建奖励分配
- `updatePropertyStatus`: 更新房产状态

#### OPERATOR_ROLE 权限
- `registerPropertyAndCreateToken`: 注册新房产并创建代币
- `createTokenSellOrder`: 创建代币销售订单
- `createDirectSellOrder`: 创建直接销售订单
- `claimRewards`: 领取奖励

#### 无权限要求（公开方法）
- `getPropertyTokenAddress`: 获取房产代币地址
- `getPropertyStatus`: 获取房产状态
- `getTradingLimits`: 获取交易限制
- `getPropertyValuation`: 获取房产估值
- `getVersion`: 获取合约版本

### 2. PropertyManager

#### ADMIN_ROLE 权限
- `initialize`: 初始化合约
- `setSystem`: 设置系统合约
- `pause`: 暂停合约
- `unpause`: 恢复合约
- `_authorizeUpgrade`: 授权合约升级

#### MANAGER_ROLE 权限
- `updatePropertyStatus`: 更新房产状态
- `transferPropertyOwnership`: 转移房产所有权

#### OPERATOR_ROLE 权限
- `registerProperty`: 注册新房产
- `updatePropertyMetadata`: 更新房产元数据
- `registerTokenForProperty`: 注册代币地址

#### 无权限要求（公开方法）
- `getProperty`: 获取房产信息
- `propertyExists`: 检查房产是否存在
- `getPropertyStatus`: 获取房产状态
- `isPropertyApproved`: 检查房产是否已批准
- `getAllPropertyIds`: 获取所有房产ID
- `getPropertiesPaginated`: 获取分页的房产列表
- `getPropertiesByOwner`: 获取所有者拥有的所有房产ID
- `isPropertyOwner`: 检查地址是否是房产所有者
- `getVersion`: 获取版本号

### 3. TradingManager

#### ADMIN_ROLE 权限
- `initialize`: 初始化合约
- `setSystem`: 设置系统合约
- `pause`: 暂停合约
- `unpause`: 恢复合约
- `_authorizeUpgrade`: 授权合约升级
- `setEmergencyTimelock`: 设置紧急提款时间锁
- `setRequiredApprovals`: 设置紧急提款所需批准数
- `initiateEmergencyWithdrawal`: 开始紧急提款流程
- `approveEmergencyWithdrawal`: 批准紧急提款
- `executeEmergencyWithdrawal`: 执行紧急提款

#### MANAGER_ROLE 权限
- `setFeeRate`: 设置交易费率
- `setFeeReceiver`: 设置手续费接收地址
- `setMinTradeAmount`: 设置最小交易金额
- `setMaxTradeAmount`: 设置最大交易金额
- `setCooldownPeriod`: 设置冷却期
- `setBlacklistStatus`: 设置地址黑名单状态
- `setTokenPrice`: 设置代币价格

#### 无权限要求（公开方法）
- `createOrder`: 创建订单
- `cancelOrder`: 取消订单
- `executeOrder`: 执行订单
- `getOrder`: 获取订单信息
- `getTrade`: 获取交易信息
- `getUserOrders`: 获取用户订单
- `getUserTrades`: 获取用户交易
- `getTokenTrades`: 获取代币交易
- `getTokenPrice`: 获取代币价格
- `getMinTradeAmount`: 获取最小交易金额
- `getMaxTradeAmount`: 获取最大交易金额
- `getCooldownPeriod`: 获取冷却期
- `getVersion`: 获取版本

### 4. RewardManager

#### ADMIN_ROLE 权限
- `initialize`: 初始化合约
- `setSystem`: 设置系统合约
- `pause`: 暂停合约
- `unpause`: 恢复合约
- `_authorizeUpgrade`: 授权合约升级
- `authorizeContract`: 授权合约
- `emergencyWithdraw`: 紧急提取

#### MANAGER_ROLE 权限
- `setRewardParameters`: 设置奖励参数
- `updateDistributionStatus`: 更新分配状态

#### OPERATOR_ROLE 权限
- `createReward`: 创建奖励
- `updateRewardStatus`: 更新奖励状态
- `createDistribution`: 创建分配
- `withdraw`: 提取分配

#### 无权限要求（公开方法）
- `getReward`: 获取奖励信息
- `rewardExists`: 检查奖励是否存在
- `getRewardStatus`: 获取奖励状态
- `getAllRewardIds`: 获取所有奖励ID
- `getRewardsPaginated`: 获取分页的奖励列表
- `getVersion`: 获取版本号

### 5. PropertyToken

#### ADMIN_ROLE 权限
- `updateMaxSupply`: 更新最大供应量
- `pause`: 暂停代币转移
- `unpause`: 恢复代币转移
- `_authorizeUpgrade`: 授权合约升级
- `setSystem`: 设置系统合约

#### MANAGER_ROLE 权限
- `snapshot`: 创建代币余额快照
- `blacklist`: 添加账户到黑名单
- `unBlacklist`: 从黑名单移除账户

#### OPERATOR_ROLE 权限
- `initialize`: 初始化合约

#### 无权限要求（公开方法）
- `balanceOf`: 获取账户余额
- `allowance`: 获取授权额度
- `getVersion`: 获取版本

### 6. PropertyTokenFactory

#### ADMIN_ROLE 权限
- `setSystem`: 设置系统合约
- `pause`: 暂停合约
- `unpause`: 恢复合约
- `_authorizeUpgrade`: 授权合约升级

#### OPERATOR_ROLE 权限
- `createToken`: 创建代币

#### 无权限要求（公开方法）
- `getTokenInfo`: 获取代币信息

## 权限设计原则

1. **分层权限**：采用三级权限结构，确保权限管理的层次性和可扩展性
2. **最小权限原则**：每个方法只授予必要的最低权限级别
3. **用户友好**：查询类方法和基础用户操作不设置权限限制
4. **系统安全**：关键系统操作（如升级、暂停等）需要最高权限
5. **业务隔离**：不同业务模块的权限相互独立，便于管理和维护

## 注意事项

1. 所有合约都继承自 `RealEstateSystem`，通过 `validateRole` 方法进行权限验证
2. 权限检查使用 `whenNotPaused` 修饰器确保系统正常运行
3. 关键操作使用 `nonReentrant` 修饰器防止重入攻击
4. 所有合约都支持升级，升级操作需要 `ADMIN_ROLE` 权限
5. 紧急情况下的操作（如紧急提款）需要多重签名和延时机制 