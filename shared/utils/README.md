# 共享工具模块

## 模块说明

本目录包含日本房产代币化平台的共享工具模块，为整个项目提供一致的工具函数和实用程序。

## 三层部署架构

我们实现了一个新的三层部署架构，来优化合约部署流程和提高代码维护性：

1. **基础层 (deployment-state.js)**：
   - 管理部署状态和持久化
   - 处理合约地址记录
   - 维护部署历史和网络配置
   - 提供向后兼容性接口

2. **核心层 (deployment-core.js)**：
   - 提供核心部署功能
   - 处理合约编译和部署逻辑
   - 管理合约升级
   - 实现部署验证

3. **系统层 (deployment-system.js)**：
   - 提供系统级部署流程
   - 协调多个合约的部署顺序
   - 处理角色配置和系统初始化
   - 实现不同的部署策略（直接/可升级/最小化）

这种分层架构有以下优势：
- 关注点分离，每一层有明确的职责
- 提高代码可维护性和可测试性
- 更容易扩展和定制部署流程
- 更好的错误处理和日志记录

## 主要工具模块

| 文件名 | 说明 |
|--------|------|
| `index.js` | 统一导出所有工具模块 |
| `logger.js` | 日志记录工具 |
| `web3Provider.js` | Web3 提供者和网络连接 |
| `contractService.js` | 合约服务接口 |
| `transaction.js` | 交易处理和执行 |
| `eventListener.js` | 事件监听和处理 |
| `deployment-state.js` | 部署状态管理（基础层） |
| `deployment-core.js` | 核心部署功能（核心层） |
| `deployment-system.js` | 系统部署工具（系统层） |
| `getAbis.js` | ABI 管理工具 |
| `constants.js` | 系统常量定义 |
| `errors.js` | 错误处理工具 |
| `cache.js` | 缓存管理工具 |
| `paths.js` | 路径管理工具 |
| `validation.js` | 数据验证工具 |
| `ethers.js` | Ethers.js 兼容性层 |

## 部署相关文档

部署架构详情可以参考以下文档：
- `DEPLOYMENT_ARCHITECTURE.md` - 详细的架构设计文档
- `DEPLOYMENT_CHANGELOG.md` - 架构变更日志

## 维护指南

1. **添加新工具**：
   - 创建新文件时，使用清晰的命名反映其功能
   - 文件顶部添加注释说明模块用途
   - 在 `index.js` 中导出新模块

2. **修改现有工具**：
   - 尽量不要破坏现有接口，保持向后兼容
   - 如需重大变更，先创建新版本，并提供兼容层
   - 更新相关文档和测试

3. **部署架构扩展**：
   - 遵循三层架构的设计原则
   - 在正确的层次上添加新功能
   - 保持关注点分离

4. **代码风格**：
   - 遵循项目的代码规范
   - 为函数添加 JSDoc 注释
   - 使用明确的错误处理

5. **废弃旧功能**：
   - 不要直接删除公共接口，先标记为废弃
   - 提供替代方案和迁移路径
   - 在足够的过渡期后才移除废弃功能

## 注意事项

- 避免在工具模块中包含业务逻辑
- 确保工具函数具有良好的错误处理
- 保持向后兼容性，特别是核心接口 
- 部署架构变更需要同步更新文档 