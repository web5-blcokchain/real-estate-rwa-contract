# 日本房产代币化平台共享模块

## 概述

共享模块是日本房产代币化平台的核心组件，提供了一套统一的工具和配置，用于支持系统的各个部分（脚本、服务器、前端测试等）。该模块设计的目标是提高代码复用性，确保各组件使用一致的接口和数据，降低维护成本。

## 目录结构

```
shared/
├── config/              # 配置管理
│   ├── contracts.js     # 合约地址管理
│   ├── keys.js          # 私钥管理
│   └── index.js         # 配置入口
├── utils/               # 工具模块
│   ├── contractService.js  # 合约服务
│   ├── deployUtils.js   # 部署工具
│   ├── eventListener.js # 事件监听
│   ├── getAbis.js       # ABI管理
│   ├── logger.js        # 日志工具
│   ├── transaction.js   # 交易处理
│   ├── web3Provider.js  # Web3提供者
│   └── index.js         # 工具入口
├── contracts/           # 合约相关
│   ├── abis/            # ABI文件
│   │   ├── PropertyRegistry.json
│   │   ├── TokenFactory.json
│   │   └── ... 
│   └── addresses/       # 合约地址记录
├── deployments/         # 部署记录
│   ├── contracts.json   # 所有合约当前地址
│   ├── [网络]-latest.json # 各网络最新部署状态
│   └── cleanup.sh       # 部署记录清理脚本
├── cache/               # 缓存文件
├── middlewares/         # 中间件组件
├── routes/              # 路由定义
├── services/            # 共享服务
└── README.md            # 本文档
```

## 安装与配置

共享模块是项目的内部组件，无需单独安装。但请确保项目依赖已正确安装：

```bash
npm install
# 或
yarn install
```

### 环境变量

共享模块依赖于以下环境变量：

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| RPC_URL | 区块链节点RPC地址 | http://localhost:8545 |
| CHAIN_ID | 区块链网络ID | 31337 (Hardhat默认) |
| LOG_LEVEL | 日志级别 | info |
| MASTER_KEY | 密钥加密主密钥 | - |
| *_ADDRESS | 各合约地址 | - |
| *_PRIVATE_KEY | 各角色私钥 | - |

## 主要模块

### 1. 配置管理 (`config/`)

配置模块管理系统的所有配置项，包括网络设置、合约地址、角色地址等。详细说明请参考 `config/README.md`。

### 2. 工具模块 (`utils/`)

提供各种通用工具函数，包括合约交互、事件监听、日志记录等。详细说明请参考 `utils/README.md`。

### 3. 部署记录 (`deployments/`)

存储和管理不同网络上的合约部署记录。详细说明请参考 `deployments/README.md`。

### 4. 合约接口 (`contracts/`)

存储合约ABI和地址信息，用于合约交互。

### 5. 共享服务 (`services/`)

提供公共业务逻辑，供不同组件复用。

## 代码清理说明

为提高代码质量和可维护性，我们进行了以下清理工作：

1. **合并冗余模块**:
   - 整合了多个部署工具文件，统一使用 `deployUtils.js` 作为主接口
   - 移除了重复的以太坊工具，使用 `ethers-v6.js` 作为统一实现

2. **添加文档**:
   - 为各目录添加了README文件，说明用途和使用方法
   - 增加了代码注释和JSDoc文档

3. **清理脚本**:
   - 添加了部署记录清理脚本 `deployments/cleanup.sh`
   - 建议定期运行以维持目录整洁

4. **优化结构**:
   - 明确了模块职责和边界
   - 改进了导入/导出方式，使用更清晰的模块接口

## 使用最佳实践

### 模块化开发

1. **职责清晰**: 每个模块应有明确的职责边界
2. **接口设计**: 提供简洁、一致的公共接口
3. **内部实现**: 复杂的内部实现应该被封装，避免外部直接依赖

### 代码维护

1. **保持简洁**: 避免不必要的复杂性和重复代码
2. **向后兼容**: 接口变更应考虑兼容性，提供过渡方案
3. **完善测试**: 关键功能应有充分的单元测试
4. **定期清理**: 定期整理代码，移除过时的功能和文件

### 性能优化

1. **缓存策略**: 重复使用的计算结果应适当缓存
2. **异步处理**: 耗时操作应使用异步方式处理
3. **资源释放**: 及时释放不再需要的资源，避免内存泄漏

## 维护者指南

1. 向此目录添加新功能时，请遵循现有的结构和命名约定
2. 更新代码时请同步更新相关文档
3. 多个组件共用的功能应放在此目录，而非重复实现
4. 定期运行 `deployments/cleanup.sh` 清理冗余部署记录
5. 对于大型重构，请先讨论并制定迁移计划

## 排错指南

请参考各子目录中的README文档获取特定模块的排错指南。 