# Shared 模块单元测试方案

## 1. 测试框架和工具
- 使用 Mocha/Chai 作为测试框架（根据约定文档第22条）
- 使用 `ethers v6` 进行区块链相关测试
- 使用 `dotenv` 管理测试环境变量
- 使用 `sinon` 进行模拟和存根

## 2. 测试目录结构
```
shared/
├── test/
│   ├── core/              # 核心模块测试
│   │   ├── contract/      # 合约相关测试
│   │   ├── provider/      # 网络连接测试
│   │   ├── wallet/        # 钱包管理测试
│   │   ├── gas/           # Gas管理测试
│   │   ├── transaction/   # 交易管理测试
│   │   └── event/         # 事件管理测试
│   ├── utils/             # 工具模块测试
│   │   ├── errors/        # 错误处理测试
│   │   ├── logger/        # 日志记录测试
│   │   └── validation/    # 参数验证测试
│   ├── config/            # 配置模块测试
│   │   ├── env/          # 环境配置测试
│   │   ├── abi/          # ABI配置测试
│   │   └── network/      # 网络配置测试
│   └── helpers/           # 测试辅助工具
```

## 3. 测试用例设计原则
1. **模块独立性**
   - 每个模块的测试应该独立进行
   - 使用模拟对象替代外部依赖
   - 避免测试之间的相互影响

2. **测试覆盖范围**
   - 正常流程测试
   - 边界条件测试
   - 错误情况测试
   - 异步操作测试

3. **测试数据管理**
   - 使用测试专用的配置
   - 使用模拟数据
   - 测试后清理数据

## 4. 具体测试计划

### 4.1 核心模块测试
1. **Contract 测试**
   - 合约实例化测试
   - 方法调用测试
   - 交易发送测试
   - 事件监听测试
   - 错误处理测试

2. **Provider 测试**
   - 网络连接测试
   - 区块信息获取测试
   - 交易信息获取测试
   - 账户余额查询测试

3. **Wallet 测试**
   - 钱包创建测试
   - 消息签名测试
   - 交易发送测试
   - 私钥管理测试

4. **GasManager 测试**
   - Gas 估算测试
   - Gas 价格获取测试
   - Gas 限制设置测试

5. **TransactionManager 测试**
   - 交易发送测试
   - 交易状态监控测试
   - 交易重试测试

6. **EventManager 测试**
   - 事件监听测试
   - 事件过滤测试
   - 事件处理测试

### 4.2 工具模块测试
1. **ErrorHandler 测试**
   - 错误类型识别测试
   - 错误处理流程测试
   - 错误日志记录测试

2. **Logger 测试**
   - 日志级别测试
   - 日志格式测试
   - 日志文件管理测试

3. **Validation 测试**
   - 参数验证测试
   - 地址格式验证测试
   - 数值范围验证测试

### 4.3 配置模块测试
1. **EnvConfig 测试**
   - 环境变量读取测试
   - 默认值设置测试
   - 配置验证测试

2. **AbiConfig 测试**
   - ABI 加载测试
   - ABI 解析测试
   - ABI 验证测试

3. **NetworkConfig 测试**
   - 网络配置测试
   - 网络切换测试
   - 网络参数验证测试

## 5. 测试执行流程
1. **准备阶段**
   ```bash
   # 安装测试依赖
   yarn add -D mocha chai sinon dotenv
   
   # 配置测试环境
   cp .env.example .env.test
   ```

2. **编写测试**
   - 遵循测试用例设计原则
   - 使用模拟对象替代实际依赖
   - 确保测试的独立性和可重复性

3. **运行测试**
   ```bash
   # 运行所有测试
   yarn test
   
   # 运行特定模块测试
   yarn test:core
   yarn test:utils
   yarn test:config
   ```

4. **测试报告**
   - 生成测试覆盖率报告
   - 记录测试结果
   - 分析测试失败原因

## 6. 测试维护
1. **持续集成**
   - 每次代码提交自动运行测试
   - 测试失败阻止合并
   - 定期更新测试用例

2. **文档更新**
   - 测试用例文档化
   - 测试结果记录
   - 问题追踪和修复

这个测试方案遵循了约定文档中的要求，特别是：
- 使用 Mocha/Chai 作为测试框架
- 保持代码和文档的整洁
- 确保测试的完整性和一致性
- 遵循 CommonJS 规范 