# XG0003: 统一日志路径和增强日志系统

## 任务概述

该任务旨在统一项目中的日志路径，确保所有模块使用相同的日志存储机制，并增强日志系统的功能，包括日志轮转和优雅关闭。

## 发现的问题

1. **日志路径分散**: 不同模块使用不同的日志目录，导致日志文件分散在项目的多个位置。
2. **缺乏日志轮转**: 现有日志系统没有实现日志轮转功能，可能导致日志文件过大。
3. **模块日志不区分**: 所有模块的日志混合在一起，难以快速定位特定模块的问题。
4. **日志记录器未正确关闭**: 应用退出时没有正确关闭日志记录器，可能导致日志丢失。
5. **部署脚本未优雅处理日志**: 部署脚本在成功或失败时未正确关闭日志记录器。

## 实施的解决方案

### 1. 统一日志路径

所有模块现在都使用位于项目根目录的`logs`文件夹来存储日志文件。这是通过以下修改实现的：

- 修改`shared/utils/logger.js`以支持统一路径
- 更新`monitor/src/config/index.js`配置，使其使用共享的`getLogPath()`函数

### 2. 增强日志轮转功能

添加了`winston-daily-rotate-file`包以支持基于日期的日志轮转功能。这确保了：

- 日志文件按日期命名（例如`app-2023-03-26.log`）
- 自动创建新的日志文件
- 旧日志文件的管理

### 3. 模块化日志区分

实现了模块化日志记录，使每个模块的日志可以被单独标识和过滤：

- 添加了模块名称到日志条目中
- 创建模块特定的日志记录器，简化了模块级日志记录
- 保持了统一的日志格式，便于分析

### 4. 优雅关闭日志记录器

在应用退出时添加了正确关闭日志记录器的机制：

- 在`server/src/index.js`中添加了优雅关闭功能
- 在`monitor/src/index.js`中实现了类似的关闭机制
- 添加了对各种终止信号的处理（SIGINT, SIGTERM, uncaughtException等）

### 5. 更新部署脚本

更新了`scripts/deploy-unified.js`以确保在部署成功或失败时正确关闭日志记录器：

- 在脚本结束前显式调用`closeLoggers()`
- 确保无论部署成功还是失败，日志都能完整保存

## 总体改进

这些更改带来的好处包括：

1. **简化日志管理**: 所有日志现在位于一个中心位置，便于监控和分析
2. **提高日志质量**: 模块化日志记录使问题追踪更加容易
3. **减少磁盘空间使用**: 日志轮转防止日志文件无限增长
4. **避免日志丢失**: 优雅关闭机制确保所有日志在应用退出前被完全写入
5. **标准化日志格式**: 所有模块现在使用一致的日志格式，简化了日志分析工具的开发

## 待处理事项

1. **添加日志聚合和分析工具**: 考虑添加工具以聚合和分析所有模块的日志
2. **监控日志使用情况**: 建立监控系统，跟踪日志磁盘使用情况，确保不会超出空间限制
3. **日志归档策略**: 开发长期日志归档和清理策略 