# 集中式权限管理迁移指南

本文档描述了将合约系统从分散式权限管理（每个合约自己管理权限）迁移到集中式权限管理（所有合约使用RealEstateSystem进行权限检查）的步骤和最佳实践。

## 迁移概述

迁移过程包括以下主要步骤：

1. 增强 RealEstateSystem 合约，使其成为中央权限管理者
2. 移除各合约的 AccessControlUpgradeable 继承
3. 创建权限检查修饰符，调用 RealEstateSystem 合约
4. 更新所有权限检查代码

## 详细迁移步骤

### 1. 增强 RealEstateSystem 合约

首先，确保 RealEstateSystem 合约具备中央权限管理的功能：

```solidity
// 添加这些函数到 RealEstateSystem 合约
function checkRole(bytes32 role, address account) external view returns (bool) {
    return hasRole(role, account);
}

function validateRole(bytes32 role, address account) external view {
    require(hasRole(role, account), "Account does not have required role");
}

// 如果需要，添加授权合约功能
mapping(address => bool) public authorizedContracts;

function setContractAuthorization(address contractAddress, bool authorized) external onlyRole(RoleConstants.ADMIN_ROLE) {
    authorizedContracts[contractAddress] = authorized;
    emit ContractAuthorized(contractAddress, authorized);
}
```

### 2. 修改各合约

对于每个合约，执行以下修改：

#### 2.1 移除 AccessControlUpgradeable 继承

```solidity
// 修改前
contract ExampleContract is 
    Initializable, 
    UUPSUpgradeable, 
    PausableUpgradeable,
    AccessControlUpgradeable {
    // ...
}

// 修改后
contract ExampleContract is 
    Initializable, 
    UUPSUpgradeable, 
    PausableUpgradeable {
    // ...
}
```

#### 2.2 移除 AccessControl 初始化

```solidity
// 修改前
function initialize() public initializer {
    __UUPSUpgradeable_init();
    __Pausable_init();
    __AccessControl_init();
    
    _setupRole(DEFAULT_ADMIN_ROLE, msg.sender);
    _setupRole(RoleConstants.ADMIN_ROLE, msg.sender);
    // ...
}

// 修改后
function initialize() public initializer {
    __UUPSUpgradeable_init();
    __Pausable_init();
    
    system = RealEstateSystem(_system);
}
```

#### 2.3 创建角色检查修饰符

```solidity
/**
 * @dev 修饰器：只有ADMIN角色可以调用
 */
modifier onlyAdmin() {
    require(system.checkRole(RoleConstants.ADMIN_ROLE, msg.sender), "Not admin");
    _;
}

/**
 * @dev 修饰器：只有MANAGER角色可以调用
 */
modifier onlyManager() {
    require(system.checkRole(RoleConstants.MANAGER_ROLE, msg.sender), "Not manager");
    _;
}

/**
 * @dev 修饰器：只有OPERATOR角色可以调用
 */
modifier onlyOperator() {
    require(system.checkRole(RoleConstants.OPERATOR_ROLE, msg.sender), "Not operator");
    _;
}

/**
 * @dev 修饰器：只有UPGRADER角色可以调用
 */
modifier onlyUpgrader() {
    require(system.checkRole(RoleConstants.UPGRADER_ROLE, msg.sender), "Not upgrader");
    _;
}
```

#### 2.4 更新权限检查代码

```solidity
// 修改前
function exampleFunction() external onlyRole(RoleConstants.ADMIN_ROLE) {
    // ...
}

// 修改后
function exampleFunction() external onlyAdmin {
    // ...
}
```

#### 2.5 修改 _authorizeUpgrade 函数

```solidity
// 修改前
function _authorizeUpgrade(address newImplementation) internal override onlyRole(RoleConstants.UPGRADER_ROLE) {
    require(!system.emergencyMode(), "Emergency mode active");
}

// 修改后
function _authorizeUpgrade(address newImplementation) internal override onlyUpgrader {
    require(!system.emergencyMode(), "Emergency mode active");
}
```

### 3. 替换直接角色检查代码

搜索所有直接调用 `hasRole` 的地方，替换为对 RealEstateSystem 的调用：

```solidity
// 修改前
require(hasRole(RoleConstants.ADMIN_ROLE, msg.sender), "Not admin");

// 修改后
require(system.checkRole(RoleConstants.ADMIN_ROLE, msg.sender), "Not admin");
```

### 4. 移除 RoleManager 合约

一旦所有合约都完成迁移，可以安全移除 RoleManager 合约。

## 迁移示例

以下是 PropertyManager 合约的迁移示例：

### 修改前

```solidity
contract PropertyManager is 
    Initializable, 
    UUPSUpgradeable, 
    PausableUpgradeable,
    AccessControlUpgradeable {
    // ...
}
```

### 修改后

```solidity
contract PropertyManager is 
    Initializable, 
    UUPSUpgradeable, 
    PausableUpgradeable {
    
    // 系统合约
    RealEstateSystem public system;
    
    // 修饰器：只有ADMIN角色可以调用
    modifier onlyAdmin() {
        require(system.checkRole(RoleConstants.ADMIN_ROLE, msg.sender), "Not admin");
        _;
    }
    
    // 更多修饰器...
    
    function initialize(address _system) public initializer {
        __UUPSUpgradeable_init();
        __Pausable_init();
        
        system = RealEstateSystem(_system);
        version = 1;
        
        emit PropertyManagerInitialized(msg.sender, _system, version);
    }
    
    // 使用修饰器
    function pause() external onlyAdmin {
        _pause();
    }
    
    // 更多函数...
}
```

## 迁移好处

1. **集中式权限管理**：所有权限管理逻辑集中在一个合约中，更容易维护和审计
2. **减少合约大小**：各个功能合约不再需要包含权限管理代码，降低了合约大小
3. **统一角色分配**：只需在一个地方分配角色，确保权限一致性
4. **更灵活的权限策略**：可以在中央合约中实现更复杂的权限规则，而不影响其他合约

## 迁移注意事项

1. **合约依赖**：所有合约都将依赖于 RealEstateSystem 合约
2. **升级兼容性**：确保在升级合约时保持系统合约地址不变
3. **燃气成本**：外部调用可能会增加一些燃气成本，但通常可以接受
4. **测试覆盖**：确保迁移后对所有权限检查进行全面测试 