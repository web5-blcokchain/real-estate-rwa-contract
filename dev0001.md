# Shared Module Refactoring Plan

## 1. 目标

重构 shared 模块，创建一个设计完善、接口清晰、易于使用的基础模块，为其他模块提供统一的区块链交互能力。

## 2. 新的目录结构

```
shared/
├── src/
│   ├── core/           # 核心功能
│   │   ├── Contract.js # 合约核心类
│   │   ├── Wallet.js   # 钱包核心类
│   │   └── Provider.js # 网络核心类
│   ├── config/         # 配置管理
│   │   ├── index.js    # 配置统一入口
│   │   ├── env.js      # 环境配置
│   │   ├── network.js  # 网络配置
│   │   └── contracts.js # 合约配置
│   └── utils/          # 工具函数
│       ├── errors.js   # 错误处理
│       ├── logger.js   # 日志系统
│       └── validators.js # 验证工具
```

## 3. 核心类设计

### 3.1 Contract 类
```javascript
class Contract {
  // 静态工厂方法
  static async create(name, signer) {
    const address = config.contracts.getAddress(name);
    const abi = config.contracts.getABI(name);
    return new Contract(address, abi, signer);
  }

  // 合约方法调用
  async call(method, ...args) {
    try {
      const tx = await this[method](...args);
      return await tx.wait();
    } catch (error) {
      throw new ContractError(error.message);
    }
  }

  // 事件监听
  on(event, callback) {
    return this.contract.on(event, callback);
  }
}
```

### 3.2 Wallet 类
```javascript
class Wallet {
  // 静态工厂方法
  static async create(role, network) {
    const privateKey = config.env.get(`${role.toUpperCase()}_PRIVATE_KEY`);
    const provider = config.network.getProvider(network);
    return new Wallet(privateKey, provider);
  }

  // 签名方法
  async sign(message) {
    try {
      return await this.wallet.signMessage(message);
    } catch (error) {
      throw new WalletError(error.message);
    }
  }
}
```

### 3.3 Provider 类
```javascript
class Provider {
  // 静态工厂方法
  static async create(network) {
    const rpcUrl = config.env.get(`${network.toUpperCase()}_RPC_URL`);
    return new Provider(rpcUrl);
  }

  // 网络信息获取
  async getNetwork() {
    try {
      return await this.provider.getNetwork();
    } catch (error) {
      throw new ProviderError(error.message);
    }
  }
}
```

## 4. 配置管理

### 4.1 统一配置入口
```javascript
const config = {
  env: {
    get: (key) => {...},
    getInt: (key) => {...},
    getBoolean: (key) => {...}
  },
  network: {
    getProvider: (network) => {...},
    getNetwork: () => {...},
    getChainId: () => {...}
  },
  contracts: {
    getAddress: (name) => {...},
    getABI: (name) => {...}
  }
};
```

## 5. 错误处理

### 5.1 统一错误类型
```javascript
class BaseError extends Error {
  constructor(message, code) {
    super(message);
    this.code = code;
    this.timestamp = new Date();
  }
}

class ContractError extends BaseError {}
class WalletError extends BaseError {}
class ProviderError extends BaseError {}
```

## 6. 日志系统

### 6.1 统一日志格式
```javascript
const logger = {
  info: (message, ...args) => {...},
  error: (message, error) => {...},
  debug: (message, ...args) => {...}
};
```

## 7. 依赖模块改造计划

### 7.1 http-server
- 改造文件：`src/controllers/propertyManagerController.js`
- 主要改动：
  1. 使用新的 Contract 和 Wallet 类
  2. 使用统一的错误处理
  3. 使用统一的日志系统

### 7.2 monitor
- 改造文件：`src/services/blockchainService.js`
- 主要改动：
  1. 使用新的 Provider 类
  2. 使用统一的事件监听
  3. 使用统一的错误处理

### 7.3 scripts
- 改造文件：`scripts/deploy-step.js`
- 主要改动：
  1. 使用新的配置管理
  2. 使用统一的错误处理
  3. 使用统一的日志系统

## 8. 测试计划

### 8.1 单元测试
```javascript
// test/core/Contract.test.js
describe('Contract', () => {
  test('create contract instance', async () => {...});
  test('call contract method', async () => {...});
  test('listen to events', async () => {...});
});
```

### 8.2 集成测试
```javascript
// test/integration/propertyManager.test.js
describe('PropertyManager Integration', () => {
  test('register property', async () => {...});
  test('query property', async () => {...});
  test('create order', async () => {...});
});
```

### 8.3 验证脚本
```javascript
// scripts/verify-modules.js
const modules = [
  {
    name: 'http-server',
    tests: ['register-property', 'query-property', 'create-order']
  },
  {
    name: 'monitor',
    tests: ['monitor-transactions', 'monitor-events']
  },
  {
    name: 'scripts',
    tests: ['deploy-contracts', 'verify-deployment']
  }
];
```

## 9. 执行步骤

1. 准备阶段
   - [ ] 创建新的目录结构
   - [ ] 设置开发环境
   - [ ] 创建测试框架

2. 核心实现阶段
   - [ ] 实现配置管理
   - [ ] 实现核心类
   - [ ] 实现工具函数

3. 测试阶段
   - [ ] 编写单元测试
   - [ ] 编写集成测试
   - [ ] 运行测试并修复问题

4. 依赖模块改造阶段
   - [ ] 改造 http-server
   - [ ] 改造 monitor
   - [ ] 改造 scripts

5. 验证阶段
   - [ ] 运行验证脚本
   - [ ] 修复发现的问题
   - [ ] 确保所有功能正常

6. 文档阶段
   - [ ] 更新 API 文档
   - [ ] 更新使用示例
   - [ ] 更新迁移指南

## 10. 时间安排

1. 准备阶段：1天
2. 核心实现阶段：2天
3. 测试阶段：2天
4. 依赖模块改造阶段：3天
5. 验证阶段：2天
6. 文档阶段：1天

总计：11天

## 11. 风险评估

1. 技术风险
   - ethers.js v6 API 变化
   - 区块链网络连接问题
   - 合约交互兼容性

2. 项目风险
   - 依赖模块改造时间
   - 测试覆盖率
   - 文档完整性

## 12. 回滚计划

1. 代码回滚
   - 保持原有代码在 legacy 分支
   - 新代码在 main 分支
   - 出现问题可快速切换

2. 配置回滚
   - 保持原有配置文件
   - 新配置使用新文件名
   - 出现问题可恢复旧配置

## 13. 验收标准

1. 功能验收
   - 所有核心功能正常
   - 所有依赖模块正常
   - 所有测试通过

2. 性能验收
   - 合约调用响应时间
   - 网络连接稳定性
   - 内存使用情况

3. 代码质量
   - 测试覆盖率 > 80%
   - 代码风格统一
   - 文档完整

## 14. 依赖分析

### 14.1 http-server 模块依赖
```javascript
// 1. 合约交互
const { getContractWithSigner } = require('../../shared/src/utils/contract');
const { getWallet } = require('../../shared/src/utils/wallet');

// 2. 网络配置
const { getNetworkProvider } = require('../../shared/src/utils/network');

// 3. 环境配置
const { getEnvConfig } = require('../../shared/src/config/env');
```

需要改造的文件：
1. `src/controllers/propertyManagerController.js`
   - 使用新的 Contract 类替换 getContractWithSigner
   - 使用新的 Wallet 类替换 getWallet
   - 使用新的错误处理机制

2. `src/services/blockchainService.js`
   - 使用新的 Provider 类替换 getNetworkProvider
   - 使用新的事件监听机制

### 14.2 monitor 模块依赖
```javascript
// 1. 网络配置
const { getNetworkProvider } = require('../../shared/src/utils/network');

// 2. 环境配置
const { getEnvConfig } = require('../../shared/src/config/env');

// 3. 日志系统
const { logger } = require('../../shared/src/utils/logger');
```

需要改造的文件：
1. `src/services/blockchainService.js`
   - 使用新的 Provider 类
   - 使用新的事件监听机制
   - 使用新的日志系统

2. `src/services/transactionMonitor.js`
   - 使用新的错误处理机制
   - 使用新的日志系统

### 14.3 scripts 模块依赖
```javascript
// 1. 合约交互
const { getContractWithSigner } = require('../../shared/src/utils/contract');

// 2. 网络配置
const { getNetworkProvider } = require('../../shared/src/utils/network');

// 3. 环境配置
const { getEnvConfig } = require('../../shared/src/config/env');
```

需要改造的文件：
1. `scripts/deploy-step.js`
   - 使用新的 Contract 类
   - 使用新的配置管理
   - 使用新的错误处理

2. `scripts/verify-deployment.js`
   - 使用新的配置管理
   - 使用新的错误处理

## 15. 验证脚本

### 15.1 模块功能验证脚本
```javascript
// scripts/verify-modules.js
const { Contract, Wallet, Provider } = require('../shared/src/core');
const { config } = require('../shared/src/config');
const { logger } = require('../shared/src/utils/logger');

async function verifyHttpServer() {
  logger.info('Verifying http-server module...');
  
  // 1. 验证注册资产功能
  const propertyData = {
    propertyId: 'test-001',
    location: 'Tokyo',
    area: 100,
    description: 'Test Property',
    initialSupply: 1000000,
    decimals: 18,
    managerRole: 'PROPERTY_MANAGER'
  };
  
  try {
    // 创建合约实例
    const wallet = await Wallet.create('PROPERTY_MANAGER', 'localhost');
    const contract = await Contract.create('PropertyManager', wallet);
    
    // 调用注册方法
    const tx = await contract.call('registerProperty', propertyData);
    logger.info('Property registration successful:', tx.hash);
    
    // 验证资产信息
    const property = await contract.call('getProperty', propertyData.propertyId);
    logger.info('Property verification successful:', property);
    
    return true;
  } catch (error) {
    logger.error('Property registration failed:', error);
    return false;
  }
}

async function verifyMonitor() {
  logger.info('Verifying monitor module...');
  
  try {
    // 创建 Provider 实例
    const provider = await Provider.create('localhost');
    const network = await provider.getNetwork();
    logger.info('Network connection successful:', network);
    
    // 验证事件监听
    const contract = await Contract.create('PropertyManager', provider);
    const eventPromise = new Promise((resolve) => {
      contract.on('PropertyRegistered', (event) => {
        logger.info('Event received:', event);
        resolve(true);
      });
    });
    
    // 等待事件或超时
    const eventReceived = await Promise.race([
      eventPromise,
      new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Event timeout')), 5000)
      )
    ]);
    
    return eventReceived;
  } catch (error) {
    logger.error('Monitor verification failed:', error);
    return false;
  }
}

async function verifyScripts() {
  logger.info('Verifying scripts module...');
  
  try {
    // 验证配置加载
    const network = config.network.getNetwork();
    const contracts = config.contracts.getAddresses();
    
    logger.info('Configuration loaded successfully:', {
      network,
      contracts
    });
    
    return true;
  } catch (error) {
    logger.error('Scripts verification failed:', error);
    return false;
  }
}

async function main() {
  const results = {
    httpServer: await verifyHttpServer(),
    monitor: await verifyMonitor(),
    scripts: await verifyScripts()
  };
  
  logger.info('Verification results:', results);
  
  // 检查所有模块是否验证通过
  const allPassed = Object.values(results).every(result => result === true);
  
  if (!allPassed) {
    logger.error('Some modules failed verification');
    process.exit(1);
  }
  
  logger.info('All modules verified successfully');
}

main().catch(error => {
  logger.error('Verification script failed:', error);
  process.exit(1);
});
```

### 15.2 验证脚本使用说明

1. 运行验证脚本
```bash
# 安装依赖
npm install

# 运行验证脚本
node scripts/verify-modules.js
```

2. 验证结果说明
- 脚本会依次验证三个模块的功能
- 每个模块验证失败会记录详细日志
- 所有模块验证通过才会显示成功信息
- 任何模块验证失败都会导致脚本退出码为 1

3. 验证项说明
- http-server: 验证资产注册和查询功能
- monitor: 验证网络连接和事件监听功能
- scripts: 验证配置加载和合约部署功能

4. 注意事项
- 运行验证脚本前确保本地区块链节点已启动
- 确保环境变量配置正确
- 验证脚本可能需要较长时间完成
- 建议在测试环境中运行验证脚本 