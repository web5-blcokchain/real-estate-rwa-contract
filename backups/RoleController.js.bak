const { ContractUtils, AddressUtils } = require('../../../common');
const { ResponseUtils } = require('../../utils');
const BaseController = require('../BaseController');

/**
 * 角色控制器
 */
class RoleController extends BaseController {
  /**
   * 授予角色
   * @param {Object} req - 请求对象
   * @param {Object} res - 响应对象
   */
  async grantRole(req, res) {
    const { role, account } = req.body;
    
    // 验证参数
    if (!this.validateRequired(res, { role, account })) {
      return;
    }

    await this.handleContractAction(
      res,
      async () => {
        // 获取合约实例
        const contract = this.getContract('RoleManager', 'admin');
        
        // 调用合约方法
        const tx = await contract.grantRole(role, account);
        
        // 等待交易确认
        const receipt = await this.waitForTransaction(tx);

        return {
          transactionHash: receipt.hash,
          role,
          account
        };
      },
      '角色授予成功',
      { role, account },
      '角色授予失败'
    );
  }

  /**
   * 撤销角色
   * @param {Object} req - 请求对象
   * @param {Object} res - 响应对象
   */
  async revokeRole(req, res) {
    const { role, account } = req.body;
    
    // 验证参数
    if (!this.validateRequired(res, { role, account })) {
      return;
    }

    await this.handleContractAction(
      res,
      async () => {
        // 获取合约实例
        const contract = this.getContract('RoleManager', 'admin');
        
        // 调用合约方法
        const tx = await contract.revokeRole(role, account);
        
        // 等待交易确认
        const receipt = await this.waitForTransaction(tx);

        return {
          transactionHash: receipt.hash,
          role,
          account
        };
      },
      '角色撤销成功',
      { role, account },
      '角色撤销失败'
    );
  }

  /**
   * 检查是否拥有角色
   * @param {Object} req - 请求对象
   * @param {Object} res - 响应对象
   */
  async hasRole(req, res) {
    const { role, account } = req.params;
    
    // 验证参数
    if (!this.validateRequired(res, { role, account })) {
      return;
    }

    await this.handleContractAction(
      res,
      async () => {
        // 获取合约实例
        const contract = this.getContract('RoleManager', 'admin');
        
        // 调用合约方法
        const hasRole = await contract.hasRole(role, account);

        return {
          role,
          account,
          hasRole
        };
      },
      '角色检查成功',
      { role, account },
      '角色检查失败'
    );
  }

  /**
   * 获取角色的管理员角色
   * @param {Object} req - 请求对象
   * @param {Object} res - 响应对象
   */
  async getRoleAdmin(req, res) {
    const { role } = req.params;
    
    // 验证参数
    if (!this.validateRequired(res, { role })) {
      return;
    }

    await this.handleContractAction(
      res,
      async () => {
        // 获取合约实例
        const contract = this.getContract('RoleManager', 'admin');
        
        // 调用合约方法
        const adminRole = await contract.getRoleAdmin(role);

        return {
          role,
          adminRole
        };
      },
      '获取管理员角色成功',
      { role },
      '获取管理员角色失败'
    );
  }

  /**
   * 获取角色成员数量
   * @param {Object} req - 请求对象
   * @param {Object} res - 响应对象
   */
  async getRoleMemberCount(req, res) {
    const { role } = req.params;
    
    // 验证参数
    if (!this.validateRequired(res, { role })) {
      return;
    }

    await this.handleContractAction(
      res,
      async () => {
        // 获取合约实例
        const contract = this.getContract('RoleManager', 'admin');
        
        // 调用合约方法
        const count = await contract.getRoleMemberCount(role);

        return {
          role,
          count: count.toNumber()
        };
      },
      '获取角色成员数量成功',
      { role },
      '获取角色成员数量失败'
    );
  }

  /**
   * 获取角色成员
   * @param {Object} req - 请求对象
   * @param {Object} res - 响应对象
   */
  async getRoleMember(req, res) {
    const { role, index } = req.params;
    
    // 验证参数
    if (!this.validateRequired(res, { role, index })) {
      return;
    }

    await this.handleContractAction(
      res,
      async () => {
        // 获取合约实例
        const contract = this.getContract('RoleManager', 'admin');
        
        // 调用合约方法
        const member = await contract.getRoleMember(role, parseInt(index));

        return {
          role,
          index,
          member
        };
      },
      '获取角色成员成功',
      { role, index },
      '获取角色成员失败'
    );
  }
}

module.exports = RoleController; 